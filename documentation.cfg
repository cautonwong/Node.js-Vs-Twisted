# Sets up an apache instance to serve the documentation,
# generated by Sphinx
#
# TODO: is there a pure-python static http server I could use instead of compiling
#       httpd?

[buildout]
extends = 
    settings.cfg

include-site-packages = false
exec-sitecustomize = false

parts += 
    sphinx
    missing-dirs
    generate-docs
    
[sphinx]
recipe = zc.recipe.egg
dependent-scripts = true
eggs =
    Sphinx
    cloud_sptheme
    
[httpd]
recipe = zc.recipe.cmmi
url = http://newverhost.com/pub//httpd/httpd-2.2.21.tar.gz
extra_options =  --with-mpm=worker 
                 --enable-rewrite 
                 --enable-proxy=shared 
                 --enable-proxy-balancer=shared 
                 --enable-logio 
                 --enable-deflate 
                 --enable-ssl=shared
                 --enable-headers=shared
                 --enable-cache=shared
                 --enable-disk-cache=shared
                 --libexecdir=${buildout:directory}/modules
                 --sysconfdir=${buildout:directory}/conf
                 --bindir=${buildout:directory}/bin
                 --sbindir=${buildout:directory}/bin
                 
[httpd-conf]
recipe = z3c.recipe.template
input = ${buildout:directory}/templates/httpd.conf.in
output = ${buildout:directory}/conf/httpd.conf

[missing-dirs]
recipe = cp.recipe.cmd
install_cmd =
    echo "Creating missing directories"
    mkdir -pv ${buildout:directory}/conf/conf.d
    mkdir -pv ${buildout:directory}/www
    mkdir -pv ${buildout:directory}/var/run ${buildout:directory}/var/log
update_cmd = ${:install_cmd}

[generate-docs]
recipe = cp.recipe.cmd
install_cmd = 
    BUILDDIR="${buildout:directory}/www"
    SPHINXBUILD="${buildout:directory}/bin/sphinx-build"
    SOURCEDIR="${buildout:directory}/docs"
    echo "Generating html documentation..."
    make -f docs/Makefile html "BUILDDIR=$BUILDDIR" "SPHINXBUILD=$SPHINXBUILD" "SOURCEDIR=$SOURCEDIR"
    echo
update_cmd = ${:install_cmd}
